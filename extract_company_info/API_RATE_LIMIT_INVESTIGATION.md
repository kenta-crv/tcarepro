# API制限調査レポート

## 問題の概要

- **状況**: 144件中1件成功、1件失敗で50% → 2件目でAPI制限が発生
- **エラー**: `ResourceExhausted: 429 Resource exhausted`
- **発生時刻**: 2025-11-19 17:09:34

## 現在の設定

### Python側（extract_company_info/agent/nodes.py）
- `API_CALL_INTERVAL_SECONDS = 2.0` - API呼び出し間に2秒の間隔
- `RETRY_DELAY_SECONDS = 4.0` - リトライ時の待機時間
- `RETRY_ATTEMPTS = 1` - 最大2回試行（1回リトライ）

### Worker側（app/workers/extract_company_info_worker.rb）
- 顧客間に5秒のスリープ

### 1顧客あたりのAPI呼び出し数
- URL候補取得: 1回
- 公式サイト選定: 1回（URL候補が2個以上の場合）
- 会社情報抽出: 1回
- **合計: 2-3回/顧客**

## 問題の分析

### 1. API呼び出し頻度の計算

**理論値**:
- 顧客間: 5秒
- API呼び出し間: 2秒
- 1顧客あたり2-3回のAPI呼び出し = 4-6秒
- **1顧客あたりの処理時間: 約9-11秒**

**実際のAPI呼び出し時間**:
- Google検索: 2-5秒
- 公式サイト選定: 5-12秒
- 会社情報抽出: 2-3秒
- **合計: 9-20秒/顧客**

**実質的な間隔**:
- API呼び出し自体に時間がかかるため、実質的な間隔は短い
- 例: 17:09:07にAPI呼び出し成功 → 17:09:11に2秒待機 → 17:09:28に次のAPI呼び出し開始
- **実質的な間隔: 約17秒**（API呼び出し時間 + 待機時間）

### 2. Gemini APIのクォータ制限

**無料プラン（Tier 1）**:
- **RPM (Requests Per Minute)**: 15回/分
- **TPM (Tokens Per Minute)**: 1,000,000トークン/分
- **RPD (Requests Per Day)**: 1,500回/日

**有料プラン（Tier 2）**:
- **RPM**: 20,000回/分
- **TPM**: 10,000,000トークン/分
- **RPD**: 制限なし（または非常に高い）

### 3. 問題の原因

**推定される原因**:
1. **RPM制限に達している可能性**
   - 無料プランの場合、15回/分 = 0.25回/秒
   - 現在の設定では、実質的に4-5秒に1回のAPI呼び出し
   - **理論値: 12-15回/分** → 制限ギリギリ

2. **API呼び出しの集中**
   - 1顧客あたり2-3回のAPI呼び出しが短時間に集中
   - 顧客間の5秒待機では不十分

3. **リトライによる追加呼び出し**
   - 429エラー時のリトライが追加のAPI呼び出しを発生させる

## 推奨される対策

### 1. API呼び出し間隔の増加

**Python側**:
```python
API_CALL_INTERVAL_SECONDS = 5.0  # 2秒 → 5秒に変更
```

**Worker側**:
```ruby
sleep(10)  # 5秒 → 10秒に変更
```

### 2. クォータの確認

Google Cloud Consoleで以下を確認:
1. 現在のプラン（無料/有料）
2. 実際のRPM/TPM/RPDの使用状況
3. クォータの引き上げが必要か

### 3. エクスポネンシャルバックオフの実装

429エラー発生時により長い待機時間を設定:
```python
RETRY_DELAY_SECONDS = 8.0  # 4秒 → 8秒に変更
```

### 4. バッチ処理の最適化

複数の顧客を同時に処理するのではなく、1件ずつ順次処理する

## 次のステップ

1. Google Cloud Consoleでクォータを確認
2. API呼び出し間隔を増加（5秒 → 10秒）
3. 顧客間の待機時間を増加（5秒 → 10秒）
4. テスト実行して改善を確認

