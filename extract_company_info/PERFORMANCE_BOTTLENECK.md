# パフォーマンスボトルネック分析

## 実際のログから判明した遅い原因

### 1. Worker側の待機時間が長すぎる ⚠️⚠️⚠️

**問題**: 各顧客処理後に**10秒待機**している

```ruby
# app/workers/extract_company_info_worker.rb
unless quota_exceeded || index == customer_count - 1
  Sidekiq.logger.info("ExtractCompanyInfoWorker: API呼び出し間隔のため10秒待機中...")
  sleep(10)  # ← これが長すぎる！
end
```

**影響**:
- 1顧客あたりの処理時間: 約20-40秒（Python側）
- 待機時間: 10秒（Worker側）
- **合計: 約30-50秒/顧客**

**改善策**: 10秒 → 5秒に短縮（RPM=15の場合、1分間に12回以下に制限）

### 2. ノード2（公式サイト選定）のAPI呼び出しが非常に遅い ⚠️⚠️

**実際のログ例**:
- 株式会社ヒガシ21: ノード2のAPI呼び出しが**30.17秒**かかった
- 通常は2-8秒程度

**原因**:
- 複数のURL（5個）をクロールした後のAPI呼び出し
- 大量のコンテキスト（229,458文字など）を処理する必要がある
- API呼び出し自体が遅い場合がある

**改善策**:
- クロールするURL数をさらに制限（5個 → 3個）
- コンテキストサイズを制限

### 3. 複数URLの順次クロール ⚠️

**実際のログ例**:
- 株式会社ヒガシ21: 5個のURLを順次クロール
  - 各1-2秒 × 5 = 約10秒
  - その後、API呼び出しが30秒

**改善策**:
- URL候補数の上限をさらに減らす（5個 → 3個）
- 並列処理を検討（将来的に）

## 実際の処理時間の内訳

### 株式会社ヒガシ21の例（URL候補9個 → 5個）

1. **ノード1（URL候補取得）**: 16.70秒
   - Google Search API: 10.87秒
   - 待機時間: 3秒（1秒 + 2秒）
   - URL到達可能性チェック: 約3秒

2. **ノード2（公式サイト選定）**: 41.78秒 ← **最も遅い**
   - 5個のURLを順次クロール: 約10秒（各1-2秒）
   - API呼び出し: **30.17秒** ← 非常に遅い
   - 待機時間: 2秒

3. **ノード3（会社情報抽出）**: 3.25秒
   - クロール: 2.01秒
   - API呼び出し: 1.24秒

**合計: 約61.73秒**

### 通常のケース（URL候補1-2個）

1. **ノード1**: 6-10秒
2. **ノード2**: 0秒（スキップ）
3. **ノード3**: 3-5秒
4. **Worker待機**: 10秒

**合計: 約19-25秒**

## 推奨される改善策

### 1. Worker側の待機時間を短縮 ✅ 最優先

```ruby
# 10秒 → 5秒に短縮
sleep(5)  # RPM=15の場合、1分間に12回以下に制限（安全）
```

### 2. URL候補数の上限をさらに減らす ✅

```python
# 5個 → 3個に減らす
max_urls = 3
```

### 3. コンテキストサイズを制限 ✅

```python
# 各URLのクロール結果を制限（例: 10,000文字まで）
if len(markdown) > 10000:
    markdown = markdown[:10000]
```

